name: ci
on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: pgmcp_test
        ports: ["5432:5432"]
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=10
    env:
      DATABASE_URL: postgres://postgres:postgres@127.0.0.1:5432/pgmcp_test?sslmode=disable
      LOG_LEVEL: error
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.23"
      - name: Go tidy
        run: go mod tidy
      - name: Build Server
        run: go build -o pgmcp-server ./server
      - name: Build Client  
        run: go build -o pgmcp-client ./client
      - name: Lint
        run: |
          go vet ./...
          test -z "$(gofmt -s -l . | grep -v vendor/)"
      - name: Unit Tests
        run: go test ./server -run "TestMinNonZero|TestGuardReadOnly|TestConfigValidate|TestSanitizeInput|TestPaginatedResult|TestStreamingPaginationCalculations|TestIsExpensiveQuery|TestSimplifyExpensiveQuery" -v
      - name: Security Tests
        run: go test ./server -run "TestSanitizeInputComprehensive|TestGuardReadOnlyComprehensive|TestConfigValidationEdgeCases" -v
      - name: Client Tests
        run: go test ./client -v
      - name: Integration Tests
        run: go test ./server -v
      - name: Performance Tests (with database)
        run: go test ./server -tags=integration -run "BenchmarkQueryPerformance|TestConcurrentSafety" -v
